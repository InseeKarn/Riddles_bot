name: Daily Bot

on:
  schedule:
      - cron: "0 3,7,11,15,19,23 * * *"  # à¸£à¸±à¸™à¸—à¸¸à¸ 4 à¸Šà¸¡. à¸•à¸²à¸¡à¹€à¸§à¸¥à¸²à¹„à¸—à¸¢
      # - cron: "0 3 * * *"    # 10:00 à¹„à¸—à¸¢
      # - cron: "0 7 * * *"    # 14:00 à¹„à¸—à¸¢
      # - cron: "0 17 * * *"   # 06:00 à¹„à¸—à¸¢
      # - cron: "0 23 * * *"   # 00:00 à¹„à¸—à¸¢   # 06:00 à¹€à¸§à¸¥à¸²à¹„à¸—à¸¢ (23:00 UTC)
  workflow_dispatch:      # à¸£à¸±à¸™à¹€à¸­à¸‡à¹„à¸”à¹‰à¸ˆà¸²à¸à¸«à¸™à¹‰à¸²à¹€à¸§à¹‡à¸š

jobs:
  run-bot:
    runs-on: ubuntu-latest
    env:
      PEXELS_API: ${{ secrets.PEXELS_API }}
      YT_API: ${{ secrets.YT_API }}
      YT_PRIVACY: ${{ secrets.YT_PRIVACY }}
      YT_CATEGORY: ${{ secrets.YT_CATEGORY }}
      DIS_AUTH: ${{ secrets.DIS_AUTH }}
      UNS_ACCESS: ${{ secrets.UNS_ACCESS }}
      UNS_SECRET: ${{ secrets.UNS_SECRET }}
      UNS_APPID: ${{ secrets.UNS_APPID }}
      PIXA_API: ${{ secrets.PIXA_API }}
      DISCORD_WEBHOOK: ${{ secrets.DISCORD_WEBHOOK }}
      HAS_CRED: ${{ secrets.YT_CREDENTIALS != '' }}
      HAS_TOKEN: ${{ secrets.TOKEN_JSON != '' }}
      
    steps:
    - name: Checkout code
      uses: actions/checkout@v3

    - name: Setup Python
      uses: actions/setup-python@v4
      with:
        python-version: "3.11"

    - name: Install dependencies
      run: pip install -r requirements.txt

    # 1. à¸”à¸¶à¸‡ repo à¸—à¸±à¹‰à¸‡à¸«à¸¡à¸”à¸£à¸§à¸¡ branch state-storage
    - name: Checkout repo
      uses: actions/checkout@v3
      with:
        fetch-depth: 0  # à¸•à¹‰à¸­à¸‡à¸”à¸¶à¸‡à¸—à¸¸à¸ branch

    # âœ… à¸”à¸¶à¸‡ state
    - name: Restore state files
      run: |
        git fetch origin state-storage || echo "No state branch yet"
        git checkout state-storage -- downloaded_not_edited.json pixabay_blocked.json token.json pixabay_seen.json 2>/dev/null || echo "No state files yet"
        git checkout ${{ github.ref_name }}  # à¸à¸¥à¸±à¸šà¸¡à¸²à¸—à¸µà¹ˆ branch workflow

    # âœ… à¹„à¸Ÿà¸¥à¹Œà¸§à¹ˆà¸²à¸‡
    - name: Create empty state files if missing
      run: |
        [ -f downloaded_not_edited.json ] || echo "[]" > downloaded_not_edited.json
        [ -f pixabay_blocked.json ] || echo "[]" > pixabay_blocked.json
        [ -f token.json ] || echo "{}" > token.json
        [ -f pixabay_seen.json ] || echo "[]" > pixabay_seen.json
    
      # ðŸ›‘ à¹€à¸Šà¹‡à¸ block à¸à¹ˆà¸­à¸™à¸£à¸±à¸™ (à¸‚à¹‰à¸²à¸¡à¸–à¹‰à¸²à¹€à¸›à¹‡à¸™ cron à¹à¸¥à¸°à¸¢à¸±à¸‡à¹„à¸¡à¹ˆà¸„à¸£à¸š 24 à¸Šà¸¡.)
    - name: Check upload block
      run: |
        if [ "${{ github.event_name }}" = "schedule" ] && [ -f upload_block_until.txt ]; then
          until_ts=$(cat upload_block_until.txt)
          now_ts=$(date +%s)
          if [ "$now_ts" -lt "$until_ts" ]; then
            echo "â³ à¸¢à¸±à¸‡à¸­à¸¢à¸¹à¹ˆà¹ƒà¸™à¸Šà¹ˆà¸§à¸‡à¸šà¸¥à¹‡à¸­à¸à¸­à¸±à¸›à¹‚à¸«à¸¥à¸” à¸‚à¹‰à¸²à¸¡à¸à¸²à¸£à¸£à¸±à¸™"
            exit 0
          fi
        fi

  
    # âœ… credentials.json (à¸ªà¸£à¹‰à¸²à¸‡à¸–à¹‰à¸²à¸¡à¸µ secret)
    - name: Create credentials.json
      if: ${{ env.HAS_CRED }}
      run: printf '%s' '${{ secrets.YT_CREDENTIALS }}' > credentials.json

    # âœ… token.json (à¸ªà¸£à¹‰à¸²à¸‡à¸–à¹‰à¸²à¸¡à¸µ secret)
    - name: Create token.json
      if: ${{ env.HAS_TOKEN }}
      run: printf '%s' '${{ secrets.TOKEN_JSON }}' > token.json

    # âœ… Validate JSON
    - name: Validate JSON files
      run: |
        python -m json.tool credentials.json > /dev/null
        python -m json.tool token.json > /dev/null

    - name: Run script and set block if limit hit
      run: |
        set -e
        python main.py 2>&1 | tee run.log || true

        if grep -q "uploadLimitExceeded" run.log; then
          echo "Found YouTube upload limit â†’ Block 24 hr."
          date -u +"%Y-%m-%d %H:%M:%S UTC"
          echo $(( $(date +%s) + 86400 )) > upload_block_until.txt
          exit 0
          
          # Notify Discord
          curl -H "Content-Type: application/json" \
               -X POST \
               -d "{\"content\": \"âš ï¸ Upload Limit Detected â€” Blocked until $(date -d '+24 hours' '+%Y-%m-%d %H:%M:%S %Z')\"}" \
               "$DISCORD_WEBHOOK_URL"
        fi

    # 5. à¸šà¸±à¸™à¸—à¸¶à¸ state à¸à¸¥à¸±à¸šà¸‚à¸¶à¹‰à¸™ branch
    - name: Save state to branch
      run: |
        git config --global user.name "github-actions[bot]"
        git config --global user.email "github-actions[bot]@users.noreply.github.com"

        
        git fetch origin state-storage || true

        
        git checkout state-storage 2>/dev/null || git checkout -b state-storage

        
        git add downloaded_not_edited.json pixabay_blocked.json token.json pixabay_seen.json

        git commit -m "Update state $(date -u +'%Y-%m-%d %H:%M:%S UTC')" || echo "No changes"

        
        git push --set-upstream origin state-storage || git push
