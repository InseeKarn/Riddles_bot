name: Daily Bot

on:
  schedule:
    - cron: "0 17 * * *"   # 00:00 à¹€à¸§à¸¥à¸²à¹„à¸—à¸¢ (17:00 UTC)
    - cron: "0 23 * * *"   # 06:00 à¹€à¸§à¸¥à¸²à¹„à¸—à¸¢ (23:00 UTC)
  workflow_dispatch:      # à¸£à¸±à¸™à¹€à¸­à¸‡à¹„à¸”à¹‰à¸ˆà¸²à¸à¸«à¸™à¹‰à¸²à¹€à¸§à¹‡à¸š

jobs:
  run-bot:
    runs-on: ubuntu-latest
    env:
      YT_API: ${{ secrets.YT_API }}
      YT_PRIVACY: ${{ secrets.YT_PRIVACY }}
      YT_CATEGORY: ${{ secrets.YT_CATEGORY }}
      DIS_AUTH: ${{ secrets.DIS_AUTH }}
      UNS_ACCESS: ${{ secrets.UNS_ACCESS }}
      UNS_SECRET: ${{ secrets.UNS_SECRET }}
      UNS_APPID: ${{ secrets.UNS_APPID }}
      PIXA_API: ${{ secrets.PIXA_API }}
      DISCORD_WEBHOOK: ${{ secrets.DISCORD_WEBHOOK }}
      
    steps:
    - name: Checkout code
      uses: actions/checkout@v3

    - name: Setup Python
      uses: actions/setup-python@v4
      with:
        python-version: "3.11"

    - name: Install dependencies
      run: pip install -r requirements.txt

    # âœ… à¸”à¸¶à¸‡ state à¸¥à¹ˆà¸²à¸ªà¸¸à¸”à¸ˆà¸²à¸à¸£à¸­à¸šà¸à¹ˆà¸­à¸™ (à¸–à¹‰à¸²à¸¡à¸µ)
    - name: Restore state files from previous run
      uses: actions/download-artifact@v4
      with:
        name: state-files
        path: .
      continue-on-error: true

    # âœ… à¸–à¹‰à¸²à¹„à¸¡à¹ˆà¸¡à¸µ state à¹ƒà¸«à¹‰à¸ªà¸£à¹‰à¸²à¸‡à¹„à¸Ÿà¸¥à¹Œà¸§à¹ˆà¸²à¸‡
    - name: Create empty state files if missing
      run: |
        [ -f downloaded_not_edited.json ] || echo "[]" > downloaded_not_edited.json
        [ -f pixabay_blocked.json ] || echo "[]" > pixabay_blocked.json
        [ -f token.json ] || echo "{}" > token.json
        [ -f pixabay_seen.json ] || echo "[]" > pixabay_seen.json

    # âœ… à¸ªà¸£à¹‰à¸²à¸‡ credentials.json à¸ˆà¸²à¸ secret
    - name: Create credentials.json
      run: printf '%s' '${{ secrets.YT_CREDENTIALS }}' > credentials.json

    # âœ… à¸ªà¸£à¹‰à¸²à¸‡ token.json à¸ˆà¸²à¸ secret (à¸‚à¹‰à¸²à¸¡à¸–à¹‰à¸²à¹„à¸¡à¹ˆà¸¡à¸µ secret)
    - name: Create token.json from secret
      if: ${{ secrets.TOKEN_JSON != '' }}
      run: printf '%s' '${{ secrets.TOKEN_JSON }}' > token.json

    # âœ… à¸•à¸£à¸§à¸ˆà¸ªà¸­à¸šà¸§à¹ˆà¸² JSON à¸–à¸¹à¸à¸•à¹‰à¸­à¸‡
    - name: Validate JSON files
      run: |
        echo "Validating credentials.json..."
        python -m json.tool credentials.json > /dev/null
        echo "Validating token.json..."
        python -m json.tool token.json > /dev/null

    # ğŸ”¹ à¸£à¸±à¸™à¸ªà¸„à¸£à¸´à¸›à¸•à¹Œà¸«à¸¥à¸±à¸
    - name: Run script
      run: python main.py

    # âœ… à¹€à¸à¹‡à¸š state à¸ªà¸³à¸«à¸£à¸±à¸šà¸£à¸­à¸šà¸–à¸±à¸”à¹„à¸›
    - name: Save updated state files
      uses: actions/upload-artifact@v4
      with:
        name: state-files
        path: |
          downloaded_not_edited.json
          pixabay_blocked.json
          token.json
          pixabay_seen.json
